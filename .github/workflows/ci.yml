name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run cppcheck on C++ files
        run: |
          cppcheck --enable=warning,style,performance \
            --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --inline-suppr \
            code/*.cpp

  compile-serial:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y g++

      - name: Compile serial version
        run: |
          cd code
          g++ -O3 -std=c++11 -Wall -Wextra serial_pagerank.cpp -o serial
          echo "Serial compilation successful"

  compile-mpi:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install MPI
        run: |
          sudo apt-get update
          sudo apt-get install -y mpich libopenmpi-dev

      - name: Compile MPI version
        run: |
          cd code
          mpic++ -O3 -fopenmp -std=c++11 -Wall parallel.cpp -o parallel
          echo "MPI compilation successful"

  test-serial:
    runs-on: ubuntu-latest
    needs: compile-serial
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y g++

      - name: Create test graph
        run: |
          cd code
          # Create a small test graph (4 nodes, simple cycle)
          cat > test_graph.txt << 'EOF'
          0 1
          1 2
          2 3
          3 0
          1 3
          EOF

      - name: Compile and prepare test
        run: |
          cd code
          # Modify serial to use test graph
          sed 's/Wiki-Vote.txt/test_graph.txt/g' serial_pagerank.cpp > serial_test.cpp
          g++ -O3 -std=c++11 serial_test.cpp -o serial_test

      - name: Run test
        run: |
          cd code
          timeout 30 ./serial_test || echo "Test completed"

  static-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for common issues
        run: |
          # Check for memory leaks indicators
          grep -rn "new\|malloc" code/*.cpp | grep -v "delete\|free" || echo "Memory management check passed"
          
          # Check for TODO comments
          grep -rn "TODO\|FIXME\|XXX" code/*.cpp code/*.cu || echo "No TODOs found"
