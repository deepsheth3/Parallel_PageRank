name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run cppcheck on C++ files
        run: |
          # Run cppcheck but allow some warnings (MPI/CUDA code has external dependencies)
          cppcheck --enable=style \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=unknownMacro \
            --inline-suppr \
            code/*.cpp || true
          echo "Lint check completed"

  compile-serial:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y g++

      - name: Compile serial version
        run: |
          cd code
          g++ -O3 -std=c++11 serial_pagerank.cpp -o serial
          echo "Serial compilation successful"

  compile-mpi:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install MPI
        run: |
          sudo apt-get update
          sudo apt-get install -y mpich

      - name: Compile MPI version
        run: |
          cd code
          mpic++ -O3 -fopenmp -std=c++11 parallel.cpp -o parallel
          echo "MPI compilation successful"

  static-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check files exist
        run: |
          ls -la code/
          echo "Files verified"

      - name: Check for TODO comments
        run: |
          grep -rn "TODO\|FIXME\|XXX" code/*.cpp code/*.cu 2>/dev/null || echo "No TODOs found"
